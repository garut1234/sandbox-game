<!DOCTYPE html>
<html>
<head>
    <title>Breaworlds - Final Build Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Tahoma', sans-serif; }
        canvas { display: block; image-rendering: pixelated; }

        /* UI ELEMENTS */
        #topChatContainer { position: fixed; top: 0; left: 0; width: 100%; display: none; flex-direction: column; z-index: 4500; }
        #globalBar { width: 100%; padding: 10px 0; background: rgba(0, 0, 0, 0.9); color: #fbff00; font-weight: bold; text-align: center; border-bottom: 2px solid #444; font-size: 14px; }
        #chatBox { width: 100%; max-height: 140px; background: rgba(0, 0, 0, 0.5); color: white; overflow-y: auto; padding: 5px 0; text-align: center; }
        .chat-line { margin-bottom: 3px; font-size: 13px; text-shadow: 1px 1px black; }

        #chatInput { position: fixed; top: 160px; left: 50%; transform: translateX(-50%); width: 420px; padding: 12px; background: rgba(0,0,0,0.95); color: white; border: 2px solid #777; border-radius: 8px; display: none; z-index: 4600; outline: none; text-align: center; }

        /* HOTBAR */
        #hotbar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; background: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 12px; border: 2px solid #fff; z-index: 2000; gap: 8px; }
        .slot { width: 55px; height: 55px; background: #333; border: 2px solid #666; border-radius: 5px; display: flex; justify-content: center; align-items: center; color: white; font-size: 9px; cursor: pointer; text-align: center; }
        .slot.active { border-color: #fbff00; box-shadow: 0 0 10px #fbff00; background: #444; }

        /* LOGIN SCREEN FIX */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; z-index: 5000; color: white; }
        .login-box { text-align: center; border: 3px solid #444; padding: 40px; background: #111; width: 320px; }
        #loginScreen input { padding: 12px; width: 80%; background: #222; color: white; border: 1px solid #444; text-align: center; margin-bottom: 15px; }
        #loginScreen button { padding: 12px 50px; background: #5cb85c; color: white; border: none; cursor: pointer; font-weight: bold; font-size: 16px; width: 90%; }
        
        #flashEffect { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: none; z-index: 9999; pointer-events: none; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="flashEffect"></div>

<div id="loginScreen">
    <div class="login-box">
        <h1 style="color: #fbff00; margin-top: 0;">BREAWORLDS</h1>
        <input type="text" id="nameInput" placeholder="GrowID..." maxlength="15">
        <br>
        <button id="startBtn">CONNECT</button>
    </div>
</div>

<div id="topChatContainer">
    <div id="globalBar">WORLD: START</div>
    <div id="chatBox"></div>
</div>

<input type="text" id="chatInput" placeholder="Press Enter to talk...">

<div id="hotbar">
    <div class="slot active" id="slot-1" onclick="selectSlot(1)">ðŸ”§<br>WRENCH</div>
    <div class="slot" id="slot-2" onclick="selectSlot(2)">ðŸ§±<br>DIRT</div>
    <div class="slot" id="slot-3" id="slot-3" onclick="selectSlot(3)">ðŸ’Ž<br>STONE</div>
    <div class="slot" id="slot-4" id="slot-4" onclick="selectSlot(4)">ðŸ”¥<br>LAVA</div>
    <div class="slot" id="slot-5" id="slot-5" onclick="selectSlot(5)">ðŸš€<br>TNT</div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const chatInput = document.getElementById("chatInput");
    const chatBox = document.getElementById("chatBox");
    const loginScreen = document.getElementById("loginScreen");
    const topUI = document.getElementById("topChatContainer");

    let gameStarted = false;
    let playerName = "";
    let playerRole = localStorage.getItem("playerRole") || "PLAYER";
    let isMuted = false;
    let ghostMode = false;
    let selectedSlot = 1;
    let walkAnim = 0;
    let hue = 0;
    let keys = {};
    
    const gridSize = 40;
    let player = { x: 100, y: 100, vy: 0, speed: 5, w: 30, h: 52 };
    let worldBlocks = [];
    let activeBubble = { text: "", timer: 0 };

    // Initial Floor
    for(let i=0; i < 50; i++) {
        worldBlocks.push({ x: i * gridSize, y: 520, type: "DIRT" });
    }

    // FIX TOMBOL CONNECT
    document.getElementById("startBtn").onclick = function() {
        playerName = document.getElementById("nameInput").value.trim() || "Guest";
        loginScreen.style.display = "none";
        gameStarted = true;
        addLog("SERVER", "Welcome to Breaworlds, " + playerName + "!", "#5cb85c");
    };

    function selectSlot(id) {
        selectedSlot = id;
        document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
        document.getElementById('slot-' + id).classList.add('active');
    }

    function addLog(sender, msg, color = "white") {
        const div = document.createElement("div");
        div.className = "chat-line";
        div.style.color = color;
        div.innerHTML = `<strong>${sender}:</strong> ${msg}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        topUI.style.display = "flex";
        
        if(sender === playerName) {
            activeBubble.text = msg;
            activeBubble.timer = 180;
        }
    }

    function handleCommand(input) {
        const args = input.split(" ");
        const cmd = args[0].toLowerCase();
        const hasStaffPower = (playerRole === "MOD" || playerRole === "DEV");

        if (cmd === "/unmute" && hasStaffPower) { isMuted = false; return addLog("SYSTEM", "Mute lifted.", "lime"); }
        if (isMuted) return addLog("INFO", "You are muted.", "red");

        if (input === "/iamdeveloper block") {
            playerRole = "DEV"; localStorage.setItem("playerRole", "DEV");
            return addLog("SYSTEM", "DEV STATUS ACTIVE", "cyan");
        }

        switch(cmd) {
            case "/nuke":
                if(playerRole !== "DEV") return;
                document.getElementById("flashEffect").style.display = "block";
                setTimeout(() => document.getElementById("flashEffect").style.display = "none", 400);
                addLog("GLOBAL", "WORLD NUKED BY ADMIN!", "red");
                break;
            case "/ghost":
                if(!hasStaffPower) return;
                ghostMode = !ghostMode; addLog("SYSTEM", "Ghost: " + ghostMode, "cyan");
                break;
            case "/setrole":
                if(playerRole !== "DEV") return;
                playerRole = args[1].toUpperCase();
                localStorage.setItem("playerRole", playerRole);
                addLog("SYSTEM", "Role set to " + playerRole, "cyan");
                break;
            default:
                addLog(playerName, input, (playerRole === "DEV" ? "cyan" : "white"));
        }
    }

    // INTERACTION: BREAK & PLACE
    canvas.addEventListener('mousedown', (e) => {
        if(!gameStarted) return;
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        const gx = Math.floor(mx / gridSize) * gridSize;
        const gy = Math.floor(my / gridSize) * gridSize;

        const idx = worldBlocks.findIndex(b => b.x === gx && b.y === gy);

        if (e.button === 0) { // LEFT CLICK: BREAK
            if (idx !== -1) worldBlocks.splice(idx, 1);
        } else if (e.button === 2) { // RIGHT CLICK: PLACE/WRENCH
            const slotEl = document.querySelector('.slot.active');
            const item = slotEl.innerText.replace(/[^A-Z]/g, "");

            if (item === "WRENCH") {
                if (idx !== -1) addLog("INFO", "Block Type: " + worldBlocks[idx].type, "#fbff00");
            } else {
                if (idx === -1) worldBlocks.push({ x: gx, y: gy, type: item });
            }
        }
    });

    function drawHuman(x, y) {
        ctx.save();
        ctx.translate(x, y);
        let color = (playerRole === "DEV") ? `hsl(${hue}, 100%, 50%)` : (playerRole === "MOD" ? "orange" : "#FFD700");
        if(playerRole === "DEV") hue += 2;
        ctx.globalAlpha = ghostMode ? 0.5 : 1.0;
        let leg = Math.sin(walkAnim) * 8;
        ctx.fillStyle = "#222"; ctx.fillRect(5, 35, 8, 15 + leg); ctx.fillRect(17, 35, 8, 15 - leg);
        ctx.fillStyle = (playerRole === "DEV") ? color : (playerRole === "MOD" ? "#ff4500" : "#007bff");
        ctx.fillRect(0, 15, 30, 25);
        ctx.fillStyle = "#FFCC99"; ctx.fillRect(-5, 18, 5, 12); ctx.fillRect(30, 18, 5, 12); ctx.fillRect(5, 0, 20, 18);
        ctx.fillStyle = "black"; ctx.fillRect(9, 6, 3, 3); ctx.fillRect(18, 6, 3, 3);
        ctx.restore();
        ctx.fillStyle = color; ctx.font = "bold 12px Arial"; ctx.textAlign = "center";
        ctx.fillText(`[${playerRole}] ${playerName}`, x + 15, y - 10);
    }

    function drawBubble(x, y) {
        if (activeBubble.timer <= 0) return;
        ctx.font = "13px Arial";
        let tw = ctx.measureText(activeBubble.text).width;
        ctx.fillStyle = "white";
        ctx.beginPath(); ctx.roundRect(x + 15 - (tw+20)/2, y - 65, tw + 20, 28, 8); ctx.fill();
        ctx.beginPath(); ctx.moveTo(x + 10, y - 37); ctx.lineTo(x + 15, y - 30); ctx.lineTo(x + 20, y - 37); ctx.fill();
        ctx.fillStyle = "black"; ctx.textAlign = "center";
        ctx.fillText(activeBubble.text, x + 15, y - 47);
        activeBubble.timer--;
    }

    function loop() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if(!gameStarted) { requestAnimationFrame(loop); return; }

        if(chatInput.style.display === "none") {
            let move = false;
            if(keys["KeyA"]) { player.x -= player.speed; move = true; }
            if(keys["KeyD"]) { player.x += player.speed; move = true; }
            if(move) walkAnim += 0.25; else walkAnim = 0;
            
            if(ghostMode) {
                if(keys["KeyW"]) player.y -= player.speed;
                if(keys["KeyS"]) player.y += player.speed;
            } else {
                player.vy += 0.6; player.y += player.vy;
                worldBlocks.forEach(b => {
                    if (player.x < b.x + gridSize && player.x + player.w > b.x &&
                        player.y + player.h > b.y && player.y < b.y + gridSize) {
                        if (player.vy > 0) { player.y = b.y - player.h; player.vy = 0; if(keys["KeyW"]) player.vy = -13; }
                    }
                });
            }
        }

        // Render Blocks
        worldBlocks.forEach(b => {
            if(b.type === "DIRT") ctx.fillStyle = "#8B4513";
            else if(b.type === "STONE") ctx.fillStyle = "#808080";
            else if(b.type === "LAVA") ctx.fillStyle = "#FF4500";
            else if(b.type === "TNT") ctx.fillStyle = "#FF0000";
            ctx.fillRect(b.x, b.y, gridSize, gridSize);
            ctx.strokeStyle = "rgba(0,0,0,0.2)"; ctx.strokeRect(b.x, b.y, gridSize, gridSize);
        });

        drawHuman(player.x, player.y);
        drawBubble(player.x, player.y);
        requestAnimationFrame(loop);
    }

    window.onkeydown = (e) => {
        if(e.code === "Enter") {
            if(chatInput.style.display === "none") {
                chatInput.style.display = "block"; chatInput.focus();
            } else {
                if(chatInput.value.trim()) handleCommand(chatInput.value);
                chatInput.value = ""; chatInput.style.display = "none";
            }
        }
        if(chatInput.style.display === "none") keys[e.code] = true;
    };
    window.onkeyup = (e) => keys[e.code] = false;

    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    loop();
</script>
</body>
</html>
