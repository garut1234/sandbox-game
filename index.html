<!DOCTYPE html>
<html>
<head>
    <title>Sandbox Pro - Rainbow Dev Role</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        
        .hp-container {
            position: absolute; top: 15px; right: 20px;
            width: 200px; height: 25px; background: #333;
            border: 3px solid #000; border-radius: 15px; overflow: hidden; z-index: 1000;
        }
        .hp-bar { width: 100%; height: 100%; background: #ff4444; transition: width 0.3s; }

        #chatInput {
            position: absolute; bottom: 120px; left: 50%;
            transform: translateX(-50%);
            width: 400px; padding: 12px;
            background: rgba(0,0,0,0.9); color: #fff;
            border: 2px solid #00ff00; border-radius: 20px;
            display: none; z-index: 3000; outline: none;
            font-size: 16px; text-align: center;
        }

        .inventory-bar { 
            position: absolute; bottom: 25px; left: 50%; 
            transform: translateX(-50%); display: flex; 
            background: #222; padding: 10px; border: 4px solid #000; 
            border-radius: 15px; z-index: 2000;
        }
        .slot { 
            width: 55px; height: 55px; margin: 0 5px; 
            border: 3px solid #444; display: flex; 
            justify-content: center; align-items: center; 
            color: white; font-weight: bold; border-radius: 10px;
        }
        .active { border-color: #00ff00; box-shadow: 0 0 15px #00ff00; transform: scale(1.1); }
    </style>
</head>
<body>

<div class="hp-container"><div id="hpBar" class="hp-bar"></div></div>
<input type="text" id="chatInput" placeholder="Ketik /? untuk bantuan..." maxlength="50">

<div class="inventory-bar">
    <div id="slot1" class="slot active" style="background-color: #8B4513;">1</div>
    <div id="slot2" class="slot" style="background-color: #808080;">2</div>
    <div id="slot3" class="slot" style="background-color: #228B22;">3</div>
    <div id="slot4" class="slot" style="background-color: #FF4500;">4</div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const chatInput = document.getElementById("chatInput");
    
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    const tileSize = 40;
    let world = {};
    let isChatting = false;
    let ghostMode = false;
    
    // Variabel Nama & Role
    let playerName = localStorage.getItem("playerName") || "Player";
    let playerRole = localStorage.getItem("playerRole") || "PLAYER"; 
    let rainbowHue = 0; // Untuk efek warna pelangi

    let currentMessage = "";
    let chatTimer = 0;

    const blocks = { "1": "#8B4513", "2": "#808080", "3": "#228B22", "4": "#FF4500" };
    let selectedBlock = "#8B4513"; 

    function generateFullWorld() {
        world = {};
        let groundLevel = Math.floor(canvas.height / tileSize) - 1;
        let starterLevel = 10;
        for(let col = 0; col < 210; col++) {
            world[`${col},${groundLevel}`] = "#5d4037";
            world[`${col},${starterLevel}`] = "#8B4513";
            world[`${col},${starterLevel + 1}`] = "#8B4513";
        }
    }

    function loadWorld() {
        const saved = localStorage.getItem("mySandboxWorld");
        if (saved && saved !== "{}") world = JSON.parse(saved);
        else { generateFullWorld(); saveData(); }
    }

    function saveData() { localStorage.setItem("mySandboxWorld", JSON.stringify(world)); }
    loadWorld();

    let player = {
        x: 100, y: 300, w: 30, h: 40,
        vx: 0, vy: 0, speed: 5,
        jumpPower: -12, gravity: 0.6, grounded: false,
        hp: 100, dmgCooldown: 0
    };

    function processCommandOrChat(input) {
        if (input.startsWith("/")) {
            const parts = input.split(" ");
            const action = parts[0].toLowerCase();

            if (action === "/?" || action === "/help") {
                alert("COMMANDS:\n/setrole [dev/mod/player]\n/name [nama]\n/ghost | /kill | /reset");
            } 
            else if (action === "/setrole" && parts[1]) {
                const newRole = parts[1].toUpperCase();
                if (["DEV", "MOD", "PLAYER"].includes(newRole)) {
                    playerRole = newRole;
                    localStorage.setItem("playerRole", playerRole);
                }
            }
            else if (action === "/name" && parts[1]) {
                playerName = parts.slice(1).join(" ");
                localStorage.setItem("playerName", playerName);
            } 
            else if (action === "/ghost") {
                ghostMode = !ghostMode; player.vy = 0;
            } 
            else if (action === "/reset") {
                if (playerRole === "DEV") { generateFullWorld(); saveData(); }
                else { alert("Khusus Developer!"); }
            } 
            else if (action === "/kill") { player.hp = 0; }
        } else {
            currentMessage = input;
            chatTimer = 300;
        }
    }

    window.addEventListener("keydown", (e) => {
        if (e.code === "Enter") {
            if (!isChatting) {
                isChatting = true; chatInput.style.display = "block"; chatInput.focus();
            } else {
                if (chatInput.value.trim() !== "") processCommandOrChat(chatInput.value);
                chatInput.value = ""; chatInput.style.display = "none"; isChatting = false;
            }
            return;
        }
        if (isChatting) return;
        keys[e.code] = true;
        if (blocks[e.key]) {
            selectedBlock = blocks[e.key];
            document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
            document.getElementById('slot' + e.key).classList.add('active');
        }
    });

    canvas.addEventListener("mousedown", (e) => {
        if (isChatting) return;
        const pos = { col: Math.floor(e.clientX / tileSize), row: Math.floor(e.clientY / tileSize) };
        const key = `${pos.col},${pos.row}`;
        if (e.button === 0) world[key] = selectedBlock; 
        else if (e.button === 2) delete world[key];
        saveData();
    });

    canvas.oncontextmenu = (e) => e.preventDefault();
    let keys = {};
    window.onkeyup = (e) => keys[e.code] = false;

    function update() {
        if (isChatting) return;
        player.vx = 0;
        if (keys["KeyA"]) player.vx = -player.speed;
        if (keys["KeyD"]) player.vx = player.speed;

        if (ghostMode) {
            player.vy = 0;
            if (keys["KeyW"]) player.y -= player.speed;
            if (keys["KeyS"]) player.y += player.speed;
            player.x += player.vx;
        } else {
            player.vy += player.gravity;
            player.x += player.vx;
            player.y += player.vy;
            let pRow = Math.floor((player.y + player.h) / tileSize);
            let pCol = Math.floor((player.x + player.w/2) / tileSize);
            if (world[`${pCol},${pRow}`]) {
                player.y = pRow * tileSize - player.h;
                player.vy = 0; player.grounded = true;
            } else { player.grounded = false; }
            if (keys["KeyW"] && player.grounded) { player.vy = player.jumpPower; player.grounded = false; }
        }
        
        // Animasi warna pelangi
        rainbowHue = (rainbowHue + 2) % 360;

        document.getElementById("hpBar").style.width = player.hp + "%";
        if (chatTimer > 0) chatTimer--;
        if (player.hp <= 0) { player.hp = 100; player.x = 100; player.y = 300; player.vy = 0; }
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let key in world) {
            const [col, row] = key.split(",").map(Number);
            ctx.fillStyle = world[key];
            ctx.fillRect(col * tileSize, row * tileSize, tileSize, tileSize);
        }

        ctx.fillStyle = "#FFD700";
        ctx.fillRect(player.x, player.y, player.w, player.h);

        // --- DRAW NAMETAG ---
        let rolePrefix = "";
        let roleColor = "white";

        if (playerRole === "DEV") {
            rolePrefix = "[DEV] ";
            roleColor = `hsl(${rainbowHue}, 100%, 50%)`; // Efek Pelangi
        } else if (playerRole === "MOD") {
            rolePrefix = "[MOD] ";
            roleColor = "#A020F0"; // Ungu
        }

        ctx.font = "bold 14px Arial";
        ctx.textAlign = "center";
        
        let prefixWidth = ctx.measureText(rolePrefix).width;
        let nameWidth = ctx.measureText(playerName).width;
        let totalCenter = player.x + player.w / 2;
        
        // Render Prefix
        ctx.fillStyle = roleColor;
        ctx.fillText(rolePrefix, totalCenter - (nameWidth / 2), player.y - 10);
        
        // Render Nama
        ctx.fillStyle = "white";
        ctx.fillText(playerName, totalCenter + (prefixWidth / 2), player.y - 10);

        // Chat Bubble
        if (chatTimer > 0) {
            ctx.font = "16px Arial";
            const textWidth = ctx.measureText(currentMessage).width;
            const bx = totalCenter - (textWidth + 20)/2;
            const by = player.y - 55;
            ctx.fillStyle = "white";
            ctx.beginPath(); ctx.roundRect(bx, by, textWidth + 20, 30, 10); ctx.fill();
            ctx.fillStyle = "black";
            ctx.fillText(currentMessage, totalCenter, by + 20);
        }

        update();
        requestAnimationFrame(draw);
    }
    draw();
</script>
</body>
</html>
