<!DOCTYPE html>
<html>
<head>
    <title>Sandbox Pro - Full World Update</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: sans-serif; }
        canvas { display: block; }
        .hp-container { position: absolute; top: 10px; right: 20px; width: 200px; height: 25px; background: #333; border: 3px solid #000; border-radius: 15px; overflow: hidden; z-index: 100; }
        .hp-bar { width: 100%; height: 100%; background: #ff4444; transition: width 0.2s; }
        .ui-info { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; font-size: 14px; z-index: 100; }
        #chatInput { position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); width: 300px; padding: 10px; background: rgba(0,0,0,0.8); color: white; border: 2px solid #00ff00; border-radius: 5px; display: none; z-index: 2000; }
        .inventory-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; background: #333; padding: 10px; border: 3px solid #000; border-radius: 12px; z-index: 1000; }
        .slot { width: 50px; height: 50px; margin: 0 8px; border: 3px solid #555; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; border-radius: 8px; }
        .active { border-color: #00ff00; box-shadow: 0 0 15px #00ff00; transform: scale(1.1); }
    </style>
</head>
<body>

<div class="ui-info">
    <b>Command:</b> /name [nama], /ghost, /reset<br>
    <b>Enter:</b> Chat | <b>1-4:</b> Pilih Blok
</div>

<div class="hp-container"><div id="hpBar" class="hp-bar"></div></div>
<input type="text" id="chatInput" placeholder="Ketik command...">

<div class="inventory-bar">
    <div id="slot1" class="slot active" style="background-color: #8B4513;">1</div>
    <div id="slot2" class="slot" style="background-color: #808080;">2</div>
    <div id="slot3" class="slot" style="background-color: #228B22;">3</div>
    <div id="slot4" class="slot" style="background-color: #FF4500;">4</div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const chatInput = document.getElementById("chatInput");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const tileSize = 40;
    let world = {};
    let isChatting = false;
    let ghostMode = false;
    let playerName = localStorage.getItem("playerName") || "Player";
    
    const blocks = { "1": "#8B4513", "2": "#808080", "3": "#228B22", "4": "#FF4500" };
    let selectedBlock = "#8B4513"; 

    // --- FUNGSI GENERATE DUNIA ---
    function generateStarterWorld() {
        // 1. Buat Lantai Dasar (Bedrock) di sepanjang layar
        let groundLevel = Math.floor(canvas.height / tileSize) - 1;
        for(let col = 0; col < Math.ceil(canvas.width / tileSize); col++) {
            world[`${col},${groundLevel}`] = "#5d4037";
        }

        // 2. Buat Pulau Awal (Dirt) yang lebih besar (15x3 blok)
        for(let row = 10; row <= 12; row++) {
            for(let col = 0; col < 15; col++) {
                world[`${col},${row}`] = "#8B4513";
            }
        }
    }

    function loadWorld() {
        const saved = localStorage.getItem("mySandboxWorld");
        if (saved) {
            world = JSON.parse(saved);
        } else {
            generateStarterWorld();
            localStorage.setItem("mySandboxWorld", JSON.stringify(world));
        }
    }
    loadWorld();

    let clouds = [];
    for(let i=0; i<5; i++) clouds.push({x: Math.random()*canvas.width, y: Math.random()*(canvas.height/2), s: 0.2+Math.random()*0.5, w: 100+Math.random()*100});

    let player = {
        x: 100, y: 200, w: 30, h: 38,
        vx: 0, vy: 0, speed: 5,
        jumpPower: -12, gravity: 0.6, grounded: false,
        hp: 100, dmgCooldown: 0
    };

    function getGridPos(x, y) { return { col: Math.floor(x / tileSize), row: Math.floor(y / tileSize) }; }
    function getBlockAt(px, py) {
        if (ghostMode) return null;
        let p = getGridPos(px, py);
        return world[`${p.col},${p.row}`];
    }

    function processCommand(cmd) {
        const parts = cmd.split(" ");
        const action = parts[0].toLowerCase();
        if (action === "/name" && parts[1]) { playerName = parts.slice(1).join(" "); localStorage.setItem("playerName", playerName); }
        if (action === "/ghost") { ghostMode = !ghostMode; player.vy = 0; }
        if (action === "/kill") player.hp = 0;
        if (action === "/reset") { localStorage.removeItem("mySandboxWorld"); location.reload(); }
    }

    window.addEventListener("keydown", (e) => {
        if (e.code === "Enter") {
            if (!isChatting) { isChatting = true; chatInput.style.display = "block"; chatInput.focus(); }
            else { if (chatInput.value.startsWith("/")) processCommand(chatInput.value); chatInput.value = ""; chatInput.style.display = "none"; isChatting = false; }
            return;
        }
        if (isChatting) return;
        keys[e.code] = true;
        if (blocks[e.key]) {
            selectedBlock = blocks[e.key];
            document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
            document.getElementById('slot' + e.key).classList.add('active');
        }
    });

    canvas.addEventListener("mousedown", (e) => {
        if (isChatting) return;
        const pos = getGridPos(e.clientX, e.clientY);
        const key = `${pos.col},${pos.row}`;
        if (e.button === 0) world[key] = selectedBlock; 
        else if (e.button === 2) delete world[key];
        localStorage.setItem("mySandboxWorld", JSON.stringify(world));
    });

    canvas.oncontextmenu = (e) => e.preventDefault();
    let keys = {};
    window.onkeyup = (e) => keys[e.code] = false;

    function update() {
        if (isChatting) return;
        player.vx = 0;
        if (keys["KeyA"]) player.vx = -player.speed;
        if (keys["KeyD"]) player.vx = player.speed;

        if (ghostMode) {
            player.vy = 0;
            if (keys["KeyW"]) player.y -= player.speed;
            if (keys["KeyS"]) player.y += player.speed;
            player.x += player.vx;
        } else {
            let lastVy = player.vy;
            player.vy += player.gravity;
            player.x += player.vx;
            if (getBlockAt(player.x, player.y+5) || getBlockAt(player.x+player.w, player.y+5) || getBlockAt(player.x, player.y+player.h-5) || getBlockAt(player.x+player.w, player.y+player.h-5)) player.x -= player.vx;
            player.grounded = false;
            player.y += player.vy;
            let fL = getBlockAt(player.x + 5, player.y + player.h);
            let fR = getBlockAt(player.x + player.w - 5, player.y + player.h);
            if (fL || fR) {
                if (lastVy > 15) player.hp -= Math.floor(lastVy * 2);
                if ((fL === "#FF4500" || fR === "#FF4500") && player.dmgCooldown <= 0) { player.hp -= 10; player.dmgCooldown = 30; }
                player.y = getGridPos(player.x, player.y + player.h).row * tileSize - player.h;
                player.vy = 0; player.grounded = true;
            }
            if (keys["KeyW"] && player.grounded) { player.vy = player.jumpPower; player.grounded = false; }
        }
        document.getElementById("hpBar").style.width = Math.max(0, player.hp) + "%";
        if (player.hp <= 0) { player.hp = 100; player.x = 100; player.y = 200; player.vy = 0; }
        if (player.dmgCooldown > 0) player.dmgCooldown--;
        clouds.forEach(c => { c.x -= c.s; if(c.x + c.w < 0) c.x = canvas.width; });
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#FFEB3B"; ctx.beginPath(); ctx.arc(canvas.width - 80, 80, 40, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "white";
        clouds.forEach(c => { ctx.beginPath(); ctx.ellipse(c.x, c.y, c.w/2, 20, 0, 0, Math.PI*2); ctx.fill(); });

        for (let key in world) {
            const [col, row] = key.split(",").map(Number);
            ctx.fillStyle = world[key];
            ctx.fillRect(col * tileSize, row * tileSize, tileSize, tileSize);
            ctx.strokeStyle = "rgba(0,0,0,0.3)"; ctx.strokeRect(col * tileSize, row * tileSize, tileSize, tileSize);
        }

        // Karakter & Nametag
        ctx.globalAlpha = ghostMode ? 0.4 : 1.0;
        ctx.fillStyle = (player.dmgCooldown > 0) ? "white" : "#FFD700";
        ctx.fillRect(player.x, player.y, player.w, player.h);
        ctx.globalAlpha = 1.0;
        ctx.fillStyle = "white"; ctx.font = "bold 14px sans-serif"; ctx.textAlign = "center";
        ctx.shadowColor = "black"; ctx.shadowBlur = 4;
        ctx.fillText(playerName, player.x + player.w/2, player.y - 10);
        ctx.shadowBlur = 0;

        update();
        requestAnimationFrame(draw);
    }
    draw();
</script>
</body>
</html>
